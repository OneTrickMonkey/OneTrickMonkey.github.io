var BITMAPS=true;var DEBUG=false;var GLOWEFFECT=true;var GLOWSHADOWBLUR=8;var SCOREDBKEY="asteroids-score-1.1";var g_asteroidImgs=[];g_asteroidImgs[0]=new Image;g_asteroidImgs[1]=new Image;g_asteroidImgs[2]=new Image;g_asteroidImgs[3]=new Image;var g_shieldImg=new Image;var g_backgroundImg=new Image;var g_playerImg=new Image;var g_enemyshipImg=new Image;window.addEventListener("load",onloadHandler,false);function onloadHandler(){var lat,locale="en";if((lat=window.location.search.indexOf("locale="))!==-1){var parts=window.location.search.substring(lat+7).split("&");if(parts.length!==0){locale=parts[0]}}Game.Util.loadMessages(locale);g_backgroundImg.src="images/bg3_1.jpg";g_backgroundImg.onload=function(){GameHandler.init();if(GameHandler.audioContext){GameHandler.loadSound("sounds/laser.mp3","laser");GameHandler.loadSound("sounds/enemybomb.mp3","enemy_bomb");GameHandler.loadSound("sounds/bigboom.mp3","big_boom");GameHandler.loadSound("sounds/explosion1.mp3","asteroid_boom1");GameHandler.loadSound("sounds/explosion2.mp3","asteroid_boom2");GameHandler.loadSound("sounds/explosion3.mp3","asteroid_boom3");GameHandler.loadSound("sounds/explosion4.mp3","asteroid_boom4");GameHandler.loadSound("sounds/powerup.mp3","powerup")}GameHandler.start(new Asteroids.Main)}}if(typeof Asteroids=="undefined"||!Asteroids){var Asteroids={}}Asteroids.Colours={PARTICLE:"rgb(255,125,50)",ENEMY_SHIP:"rgb(200,200,250)",ENEMY_SHIP_DARK:"rgb(150,150,200)",GREEN_LASER:"rgb(120,255,120)",GREEN_LASER_DARK:"rgb(50,255,50)",GREEN_LASERX2:"rgb(120,255,150)",GREEN_LASERX2_DARK:"rgb(50,255,75)",PLAYER_BOMB:"rgb(155,255,155)",PLAYER_THRUST:"rgb(25,125,255)",PLAYER_SHIELD:"rgb(100,100,255)"};(function(){Asteroids.Main=function(){Asteroids.Main.superclass.constructor.call(this);var attractorScene=new Asteroids.AttractorScene(this);var loader=new Game.Preloader;loader.addImage(g_playerImg,"images/player.png");loader.addImage(g_asteroidImgs[0],"images/asteroid1.png");loader.addImage(g_asteroidImgs[1],"images/asteroid2.png");loader.addImage(g_asteroidImgs[2],"images/asteroid3.png");loader.addImage(g_asteroidImgs[3],"images/asteroid4.png");loader.addImage(g_shieldImg,"images/shield.png");loader.addImage(g_enemyshipImg,"images/enemyship1.png");loader.onLoadCallback(function(){attractorScene.ready()});this.player=new Asteroids.Player(new Vector(GameHandler.width/2,GameHandler.height/2),new Vector(0,0),0);this.scenes.push(attractorScene);for(var level,i=0;i<12;i++){level=new Asteroids.GameScene(this,i+1);this.scenes.push(level)}this.scenes.push(new Asteroids.GameCompleted(this));this.endScene=new Asteroids.GameOverScene(this);for(var star,i=0;i<this.STARFIELD_SIZE;i++){star=new Asteroids.Star;star.init();this.starfield.push(star)}if(localStorage){var highscore=localStorage.getItem(SCOREDBKEY);if(highscore){this.highscore=highscore}}GameHandler.bitmaps=new Asteroids.Prerenderer;GameHandler.bitmaps.execute()};extend(Asteroids.Main,Game.Main,{STARFIELD_SIZE:64,player:null,lives:0,score:0,highscore:0,backgroundX:0,starfield:[],onRenderGame:function onRenderGame(ctx){if(BITMAPS&&!(DEBUG&&DEBUG.NOBACKGROUND)){ctx.drawImage(g_backgroundImg,this.backgroundX,0,GameHandler.width,GameHandler.height,0,0,GameHandler.width,GameHandler.height);this.backgroundX+=.25*GameHandler.frameMultipler;if(this.backgroundX>=g_backgroundImg.width*.5){this.backgroundX-=g_backgroundImg.width*.5}ctx.shadowBlur=0}else{ctx.shadowBlur=0;ctx.clearRect(0,0,GameHandler.width,GameHandler.height);if(!(DEBUG&&DEBUG.NOBACKGROUND))this.updateStarfield(ctx);ctx.shadowBlur=GLOWEFFECT?GLOWSHADOWBLUR:0;ctx.lineWidth=1.5}},isGameOver:function isGameOver(){return this.lives===0&&(this.currentScene.effects&&this.currentScene.effects.length===0)},updateStarfield:function updateStarfield(ctx){ctx.save();ctx.strokeStyle="rgb(200,200,200)";for(var s,i=0,j=this.starfield.length;i<j;i++){s=this.starfield[i];s.render(ctx);s.z-=s.VELOCITY*GameHandler.frameMultipler*.1;if(s.z<.1||s.prevx>GameHandler.height||s.prevy>GameHandler.width){s.init()}}ctx.restore()},updateActorPosition:function updateActorPosition(actor){actor.position.add(actor.vector.nscale(GameHandler.frameMultipler));if(actor.position.x>=GameHandler.width){actor.position.x=0}else if(actor.position.x<0){actor.position.x=GameHandler.width-1}if(actor.position.y>=GameHandler.height){actor.position.y=0}else if(actor.position.y<0){actor.position.y=GameHandler.height-1}}})})();(function(){Asteroids.AttractorScene=function(game){this.game=game;var me=this;var fMouseDown=function(e){if(e.button===0&&me.imagesLoaded){me.start=true;return true}};GameHandler.canvas.addEventListener("mousedown",fMouseDown,false);Asteroids.AttractorScene.superclass.constructor.call(this,false,null)};extend(Asteroids.AttractorScene,Game.Scene,{game:null,start:false,imagesLoaded:false,sine:0,mult:0,multIncrement:0,actors:null,SCENE_LENGTH:400,SCENE_FADE:75,sceneRenderers:null,currentSceneRenderer:0,currentSceneFrame:0,isComplete:function isComplete(){return this.start},onInitScene:function onInitScene(){this.start=false;this.mult=512;this.multIncrement=.5;this.currentSceneRenderer=0;this.currentSceneFrame=0;this.sceneRenderers=[];this.sceneRenderers.push(this.sceneRendererWelcome);this.sceneRenderers.push(this.sceneRendererInfo);this.sceneRenderers.push(this.sceneRendererScores);this.actors=[];for(var i=0;i<8;i++){var pos=new Vector(Rnd()*GameHandler.width,Rnd()*GameHandler.height);var vec=new Vector(Rnd()*2-1,Rnd()*2-1);this.actors.push(new Asteroids.Asteroid(pos,vec,randomInt(3,4)))}this.game.score=0;this.game.lives=3},onRenderScene:function onRenderScene(ctx){if(this.imagesLoaded){for(var n=0,j=this.actors.length;n<j;n++){var actor=this.actors[n];actor.onUpdate(this);this.game.updateActorPosition(actor);actor.onRender(ctx)}if(++this.currentSceneFrame===this.SCENE_LENGTH){if(++this.currentSceneRenderer===this.sceneRenderers.length){this.currentSceneRenderer=0}this.currentSceneFrame=0}ctx.save();if(this.currentSceneFrame<this.SCENE_FADE){ctx.globalAlpha=1-(this.SCENE_FADE-this.currentSceneFrame)/this.SCENE_FADE}else if(this.currentSceneFrame>=this.SCENE_LENGTH-this.SCENE_FADE){ctx.globalAlpha=(this.SCENE_LENGTH-this.currentSceneFrame)/this.SCENE_FADE}this.sceneRenderers[this.currentSceneRenderer].call(this,ctx);ctx.restore();this.sineText(ctx,Game.Util.message("title"),GameHandler.width*.5-180,GameHandler.height*.5-64)}else{var t=BITMAPS?Game.centerFillText:Game.centerDrawText;t(ctx,Game.Util.message("please-wait"),"18pt Arial",GameHandler.height*.5,"white")}},sceneRendererWelcome:function sceneRendererWelcome(ctx){ctx.fillStyle=ctx.strokeStyle="white";var t=BITMAPS?Game.centerFillText:Game.centerDrawText;t(ctx,!iOS?Game.Util.message("start"):"Touch to start!","18pt Arial",GameHandler.height*.5);t=BITMAPS?Game.fillText:Game.drawText;t(ctx,Game.Util.message("author"),"10pt Arial",16,624)},sceneRendererInfo:function sceneRendererInfo(ctx){ctx.fillStyle=ctx.strokeStyle="white";var t=BITMAPS?Game.fillText:Game.drawText;if(!iOS){t(ctx,Game.Util.message("instruction1"),"14pt Arial",40,320);t(ctx,Game.Util.message("instruction2"),"14pt Arial",40,350);t(ctx,Game.Util.message("instruction3"),"14pt Arial",40,370);t(ctx,Game.Util.message("instruction4"),"14pt Arial",40,390);t(ctx,Game.Util.message("instruction5"),"14pt Arial",40,410);t(ctx,Game.Util.message("instruction6"),"14pt Arial",40,430)}else{t(ctx,Game.Util.message("instruction1"),"14pt Arial",40,320);t(ctx,"Touch in the left hand side of the screen and drag left/right to rotate.","14pt Arial",40,350);t(ctx,"Touch in the right hand side of the screen and drag up to thrust","14pt Arial",40,370);t(ctx,"and flick down for shield.","14pt Arial",40,390);t(ctx,Game.Util.message("instruction3"),"14pt Arial",40,410);t(ctx,Game.Util.message("instruction4"),"14pt Arial",40,430)}},sceneRendererScores:function sceneRendererScores(ctx){ctx.fillStyle=ctx.strokeStyle="white";var t=BITMAPS?Game.centerFillText:Game.centerDrawText;t(ctx,Game.Util.message("high-score"),"18pt Courier New",320);var sscore=this.game.highscore.toString();for(var i=0,j=8-sscore.length;i<j;i++){sscore="0"+sscore}t(ctx,sscore,"18pt Courier New",350)},ready:function ready(){this.imagesLoaded=true},sineText:function sineText(ctx,txt,xpos,ypos){this.mult+=this.multIncrement;if(this.mult>1024){this.multIncrement=-this.multIncrement}else if(this.mult<128){this.multIncrement=-this.multIncrement}var offset=this.sine;for(var i=0,j=txt.length;i<j;i++){var y=ypos+Sin(offset)*RAD*this.mult;var x=xpos+Cos(offset++)*RAD*(this.mult*.5);var f=BITMAPS?Game.fillText:Game.drawText;f(ctx,txt[i],"36pt Courier New",x+i*30,y,"green")}this.sine+=.075},onKeyDownHandler:function onKeyDownHandler(keyCode){switch(keyCode){case GameHandler.KEY.SPACE:{if(this.imagesLoaded){this.start=true}return true;break}case GameHandler.KEY.R:{BITMAPS=!BITMAPS;return true;break}case GameHandler.KEY.S:{GameHandler.soundEnabled=!GameHandler.soundEnabled;return true;break}case GameHandler.KEY.ESC:{GameHandler.pause();return true;break}}}})})();(function(){Asteroids.GameOverScene=function(game){this.game=game;this.player=game.player;var interval=new Game.Interval(Game.Util.message("game-over"),this.intervalRenderer);Asteroids.GameOverScene.superclass.constructor.call(this,false,interval)};extend(Asteroids.GameOverScene,Game.Scene,{game:null,isComplete:function isComplete(){return true},intervalRenderer:function intervalRenderer(interval,ctx){if(interval.framecounter++===0){if(this.game.score===this.game.highscore){if(localStorage){localStorage.setItem(SCOREDBKEY,this.game.score)}try{if($){var score=this.game.score;$("#results").html(Game.Util.message("new-high-score")+": "+score);var tweet="http://twitter.com/home/?status=I%20scored:%20"+score+"%20-%20in%20the%20Asteroids%20[Reloaded]%20HTML5%20game!%20Try%20your%20skillz...%20http://bit.ly/asteroids%20%23javascript%20%23html5";$("#tweetlink").attr("href",tweet);$("#results-wrapper").fadeIn()}}catch(e){}}}if(interval.framecounter<300){Game.fillText(ctx,interval.label,"18pt Courier New",GameHandler.width*.5-64,GameHandler.height*.5-32,"white");Game.fillText(ctx,Game.Util.message("score")+": "+this.game.score,"14pt Courier New",GameHandler.width*.5-64,GameHandler.height*.5,"white");if(this.game.score===this.game.highscore){Game.fillText(ctx,Game.Util.message("new-high-score")+"!","14pt Courier New",GameHandler.width*.5-64,GameHandler.height*.5+24,"white")}}else{interval.complete=true}}})})();(function(){Asteroids.GameCompleted=function(game){this.game=game;this.player=game.player;var interval=new Game.Interval(Game.Util.message("congratulations"),this.intervalRenderer);Asteroids.GameCompleted.superclass.constructor.call(this,false,interval)};extend(Asteroids.GameCompleted,Game.Scene,{game:null,isComplete:function isComplete(){return true},intervalRenderer:function intervalRenderer(interval,ctx){if(interval.framecounter++===0){if(this.game.score===this.game.highscore){if(localStorage){localStorage.setItem(SCOREDBKEY,this.game.score)}}}if(interval.framecounter<1e3){Game.fillText(ctx,interval.label,"18pt Courier New",GameHandler.width*.5-96,GameHandler.height*.5-32,"white");Game.fillText(ctx,Game.Util.message("score")+": "+this.game.score,"14pt Courier New",GameHandler.width*.5-64,GameHandler.height*.5,"white");if(this.game.score===this.game.highscore){Game.fillText(ctx,Game.Util.message("new-high-score")+"!","14pt Courier New",GameHandler.width*.5-64,GameHandler.height*.5+24,"white")}}else{interval.complete=true}}})})();(function(){Asteroids.GameScene=function(game,wave){this.game=game;this.wave=wave;this.player=game.player;var interval=new Game.Interval(Game.Util.message("wave")+" "+wave,this.intervalRenderer);Asteroids.GameScene.superclass.constructor.call(this,true,interval)};extend(Asteroids.GameScene,Game.Scene,{game:null,wave:0,input:{left:false,right:false,thrust:false,shield:false,fireA:false,fireB:false},player:null,actors:null,playerBullets:null,enemies:null,enemyBullets:null,effects:null,collectables:null,enemyShipCount:0,enemyShipAdded:0,scoredisplay:0,skipLevel:false,onInitScene:function onInitScene(){this.actors=[];this.enemies=[];this.actors.push(this.enemies);this.actors.push(this.playerBullets=[]);this.actors.push(this.enemyBullets=[]);this.actors.push(this.effects=[]);this.actors.push(this.collectables=[]);this.resetPlayerActor(this.wave!==1);var factor=1+(this.wave-1)*.075;for(var i=1,j=4+this.wave;i<j;i++){this.enemies.push(this.generateAsteroid(factor))}this.enemyShipAdded=GameHandler.frameStart;this.enemyShipCount=0;this.interval.reset();this.skipLevel=false},resetPlayerActor:function resetPlayerActor(persistPowerUps){this.actors.push([this.player]);with(this.player){position.x=GameHandler.width/2;position.y=GameHandler.height/2;vector.x=0;vector.y=0;heading=0;reset(persistPowerUps)}with(this.input){left=false;right=false;thrust=false;shield=false;fireA=false;fireB=false}},onBeforeRenderScene:function onBeforeRenderScene(){if(this.input.left){this.player.heading-=4*GameHandler.frameMultipler}if(this.input.right){this.player.heading+=4*GameHandler.frameMultipler}if(this.input.thrust){this.player.thrust()}else if(iOS){this.player.vector.scale(.985)}if(this.input.shield){if(!this.player.expired()){this.player.activateShield()}}if(this.input.fireA||iOS||DEBUG&&DEBUG.AUTOFIRE){this.player.firePrimary(this.playerBullets)}if(this.input.fireB){this.player.fireSecondary(this.playerBullets)}if(this.enemyShipCount<=(this.wave<5?0:1)&&GameHandler.frameStart-this.enemyShipAdded>2e4-this.wave*1024){this.enemies.push(new Asteroids.EnemyShip(this,this.wave<3?0:randomInt(0,1)));this.enemyShipCount++;this.enemyShipAdded=GameHandler.frameStart}this.updateActors()},onRenderScene:function onRenderScene(ctx){this.renderActors(ctx);if(DEBUG&&DEBUG.COLLISIONRADIUS){this.renderCollisionRadius(ctx)}this.renderOverlay(ctx);this.collisionDetectBullets();if(!this.player.expired()){this.collisionDetectPlayer()}else{if(GameHandler.frameStart-this.player.killedOn>3e3){var tooClose=false;var playerPos=new Vector(GameHandler.width*.5,GameHandler.height*.5);for(var i=0,j=this.enemies.length;i<j;i++){var enemy=this.enemies[i];if(playerPos.distance(enemy.position)<80){tooClose=true;break}}if(tooClose===false){this.resetPlayerActor()}}}},isComplete:function isComplete(){return this.skipLevel||this.enemies.length===0&&this.effects.length===0},intervalRenderer:function intervalRenderer(interval,ctx){if(interval.framecounter++<100){var f=BITMAPS?Game.fillText:Game.drawText;f(ctx,interval.label,"18pt Courier New",GameHandler.width*.5-48,GameHandler.height*.5-8,"white")}else{interval.complete=true}},onKeyDownHandler:function onKeyDownHandler(keyCode){switch(keyCode){case GameHandler.KEY.LEFT:{this.input.left=true;return true;break}case GameHandler.KEY.RIGHT:{this.input.right=true;return true;break}case GameHandler.KEY.UP:case GameHandler.GAMEPAD+1:{this.input.thrust=true;return true;break}case GameHandler.KEY.DOWN:case GameHandler.KEY.SHIFT:case GameHandler.GAMEPAD+0:{this.input.shield=true;return true;break}case GameHandler.KEY.SPACE:case GameHandler.GAMEPAD+7:{this.input.fireA=true;return true;break}case GameHandler.KEY.Z:case GameHandler.GAMEPAD+2:{this.input.fireB=true;return true;break}case GameHandler.KEY.R:{BITMAPS=!BITMAPS;return true;break}case GameHandler.KEY.S:{GameHandler.soundEnabled=!GameHandler.soundEnabled;return true;break}case GameHandler.KEY.A:{if(DEBUG){this.enemies.push(this.generateAsteroid(1));return true}break}case GameHandler.KEY.G:{if(DEBUG){GLOWEFFECT=!GLOWEFFECT;return true}break}case GameHandler.KEY.L:{if(DEBUG){this.skipLevel=true;return true}break}case GameHandler.KEY.E:{if(DEBUG){this.enemies.push(new Asteroids.EnemyShip(this,randomInt(0,1)));return true}break}case GameHandler.KEY.ESC:{GameHandler.pause();return true;break}}},onKeyUpHandler:function onKeyUpHandler(keyCode){switch(keyCode){case GameHandler.KEY.LEFT:{this.input.left=false;return true;break}case GameHandler.KEY.RIGHT:{this.input.right=false;return true;break}case GameHandler.KEY.UP:case GameHandler.GAMEPAD+1:{this.input.thrust=false;return true;break}case GameHandler.KEY.DOWN:case GameHandler.KEY.SHIFT:case GameHandler.GAMEPAD+0:{this.input.shield=false;return true;break}case GameHandler.KEY.SPACE:case GameHandler.GAMEPAD+7:{this.input.fireA=false;return true;break}case GameHandler.KEY.Z:case GameHandler.GAMEPAD+2:{this.input.fireB=false;return true;break}}},onAxisHandler:function onAxisHandler(axis,delta){switch(axis){case 0:{switch(Math.round(delta)){case 0:{this.input.left=this.input.right=false;break}case 1:{this.input.right=true;break}case-1:{this.input.left=true;break}}break}}},touches:[],onTouchStartHandler:function onTouchStartHandler(event){for(var i=0,t;i<event.changedTouches.length;i++){t=event.changedTouches[i];this.touches[t.identifier]={tx:t.screenX,ty:t.screenY,txd:t.screenX,tyd:t.screenY}}return true},onTouchMoveHandler:function onTouchMoveHandler(event){for(var i=0,t;i<event.changedTouches.length;i++){t=event.changedTouches[i];this.touches[t.identifier].tx=t.screenX;this.touches[t.identifier].ty=t.screenY}for(var i in this.touches){if(this.touches[i].tx<window.innerWidth*.5){this.player.heading-=(this.touches[i].txd-this.touches[i].tx)*GameHandler.frameMultipler}else if(this.touches[i].ty<this.touches[i].tyd){this.player.thrust()}else if(this.touches[i].ty-16>this.touches[i].tyd){this.player.activateShield()}this.touches[i].txd=this.touches[i].tx;this.touches[i].tyd=this.touches[i].ty}return true},onTouchEndHandler:function onTouchEndHandler(event){for(var i=0,t;i<event.changedTouches.length;i++){t=event.changedTouches[i];delete this.touches[t.identifier]}return true},generateAsteroid:function generateAsteroid(speedFactor){while(true){var apos=new Vector(Rnd()*GameHandler.width,Rnd()*GameHandler.height);if(this.player.position.distance(apos)>125){var vec=new Vector((Rnd()*2-1)*speedFactor,(Rnd()*2-1)*speedFactor);return new Asteroids.Asteroid(apos,vec,4)}}},updateActors:function updateActors(){for(var i=0,j=this.actors.length;i<j;i++){var actorList=this.actors[i];for(var n=0;n<actorList.length;n++){var actor=actorList[n];actor.onUpdate(this);if(actor.expired()){actorList.splice(n,1)}else{this.game.updateActorPosition(actor)}}}},destroyPlayer:function destroyPlayer(){this.player.kill();this.game.lives--;var boom=new Asteroids.PlayerExplosion(this.player.position.clone(),this.player.vector.clone());this.effects.push(boom);GameHandler.playSound("big_boom")},collisionDetectPlayer:function collisionDetectPlayer(){var playerRadius=this.player.radius();var playerPos=this.player.position;for(var n=0,m=this.enemies.length;n<m;n++){var enemy=this.enemies[n];if(playerPos.distance(enemy.position)<=playerRadius+enemy.radius()){if(this.player.isShieldActive()){this.player.vector.scale(.75);enemy.hit(-1);this.destroyEnemy(enemy,this.player.vector,true)}else if(!(DEBUG&&DEBUG.INVINCIBLE)){this.destroyPlayer()}}}for(var i=0;i<this.enemyBullets.length;i++){var bullet=this.enemyBullets[i];if(playerPos.distance(bullet.position)<=playerRadius+bullet.radius()){if(this.player.isShieldActive()){this.enemyBullets.splice(i,1)}else if(!(DEBUG&&DEBUG.INVINCIBLE)){this.destroyPlayer()}}}for(var i=0;i<this.collectables.length;i++){var item=this.collectables[i];if(playerPos.distance(item.position)<=playerRadius+item.radius()){this.collectables.splice(i,1);item.collected(this.game,this.player,this);GameHandler.playSound("powerup")}}},collisionDetectBullets:function collisionDetectBullets(){for(var i=0,n,m;i<this.playerBullets.length;i++){var bullet=this.playerBullets[i];var bulletRadius=bullet.radius();var bulletPos=bullet.position;for(n=0,m=this.enemies.length,enemy,z;n<m;n++){enemy=this.enemies[n];if(bulletPos.distance(enemy.position)<=bulletRadius+enemy.radius()){var effectRad=bullet.effectRadius();if(effectRad===0){if(enemy.hit(bullet.power())){this.destroyEnemy(enemy,bullet.vector,true);this.generatePowerUp(enemy)}else{var effect=new Asteroids.PlayerBulletImpact(bullet.position,bullet.vector);this.effects.push(effect)}}else{enemy.hit(-1);this.generatePowerUp(enemy);var comboCount=1;var boom=new Asteroids.Explosion(bullet.position.clone(),bullet.vector.nscale(.5),5);this.effects.push(boom);this.destroyEnemy(enemy,bullet.vector,true);for(var x=0,z=this.enemies.length,e;x<z;x++){e=this.enemies[x];if(bulletPos.distance(e.position)<=effectRad+e.radius()){e.hit(-1);this.generatePowerUp(e);this.destroyEnemy(e,bullet.vector,true);comboCount++}}if(comboCount>4){var inc=comboCount*1e3*this.wave;this.game.score+=inc;var vec=new Vector(0,-3);var effect=new Asteroids.ScoreIndicator(new Vector(enemy.position.x,enemy.position.y-enemy.size*8),vec.add(enemy.vector.nscale(.5)),inc,16,Game.Util.message("hit-combo")+" X"+comboCount,"rgb(255,255,55)",1e3);this.effects.push(effect);this.generatePowerUp(enemy,true)}}this.playerBullets.splice(i,1);break}}}for(var i=0,n,m;i<this.enemyBullets.length;i++){var bullet=this.enemyBullets[i];var bulletRadius=bullet.radius();var bulletPos=bullet.position;for(n=0,m=this.enemies.length,z;n<m;n++){var enemy=this.enemies[n];if(enemy instanceof Asteroids.Asteroid){if(bulletPos.distance(enemy.position)<=bulletRadius+enemy.radius()){if(enemy.hit(1)){this.destroyEnemy(enemy,bullet.vector,false)}else{var effect=new Asteroids.EnemyBulletImpact(bullet.position,bullet.vector);this.effects.push(effect)}this.enemyBullets.splice(i,1);break}}}}},generatePowerUp:function generatePowerUp(enemy,force){if(this.collectables.length<5&&(force||randomInt(0,enemy instanceof Asteroids.Asteroid?25:1)===0)){var vec=enemy.vector.clone();var t=new Vector(0,-(Rnd()*2));t.rotate(enemy.vector.theta()*(Rnd()*PI));vec.add(t);this.collectables.push(new Asteroids.PowerUp(new Vector(enemy.position.x,enemy.position.y-enemy.size*8),vec))}},destroyEnemy:function destroyEnemy(enemy,parentVector,player){if(enemy instanceof Asteroids.Asteroid){GameHandler.playSound("asteroid_boom"+randomInt(1,4));this.generateBabyAsteroids(enemy,parentVector);var boom=new Asteroids.AsteroidExplosion(enemy.position.clone(),enemy.vector.clone(),enemy);this.effects.push(boom);if(player){var inc=(5-enemy.size)*4*100*this.wave;this.game.score+=inc;var vec=new Vector(0,-1.5).add(enemy.vector.nscale(.5));var effect=new Asteroids.ScoreIndicator(new Vector(enemy.position.x,enemy.position.y-enemy.size*8),vec,inc);this.effects.push(effect)}}else if(enemy instanceof Asteroids.EnemyShip){GameHandler.playSound("asteroid_boom1");var boom=new Asteroids.EnemyExplosion(enemy.position.clone(),enemy.vector.clone(),enemy);this.effects.push(boom);if(player){var inc=2e3*this.wave*(enemy.size+1);this.game.score+=inc;var vec=new Vector(0,-1.5).add(enemy.vector.nscale(.5));var effect=new Asteroids.ScoreIndicator(new Vector(enemy.position.x,enemy.position.y-16),vec,inc);this.effects.push(effect)}this.enemyShipCount--}},generateBabyAsteroids:function generateBabyAsteroids(asteroid,parentVector){if(asteroid.size>1){for(var x=0,xc=randomInt(asteroid.size/2,asteroid.size-1);x<xc;x++){var babySize=randomInt(1,asteroid.size-1);var vec=asteroid.vector.clone();var t=new Vector(0,-Rnd());t.rotate(asteroid.vector.theta()*(Rnd()*PI));vec.add(t);vec.add(parentVector.nscale(.2));var baby=new Asteroids.Asteroid(new Vector(asteroid.position.x+Rnd()*5-2.5,asteroid.position.y+Rnd()*5-2.5),vec,babySize,asteroid.type);this.enemies.push(baby)}}},renderActors:function renderActors(ctx){for(var i=0,j=this.actors.length;i<j;i++){var actorList=this.actors[i];for(var n=actorList.length-1;n>=0;n--){actorList[n].onRender(ctx)}}},renderCollisionRadius:function renderCollisionRadius(ctx){ctx.save();ctx.strokeStyle="rgb(255,0,0)";ctx.lineWidth=.5;ctx.shadowBlur=0;for(var i=0,j=this.actors.length;i<j;i++){var actorList=this.actors[i];for(var n=actorList.length-1,actor;n>=0;n--){actor=actorList[n];if(actor.radius){ctx.beginPath();ctx.arc(actor.position.x,actor.position.y,actor.radius(),0,TWOPI,true);ctx.closePath();ctx.stroke()}}}ctx.restore()},renderOverlay:function renderOverlay(ctx){ctx.save();ctx.shadowBlur=0;ctx.strokeStyle="rgb(50,50,255)";ctx.strokeRect(4,4,101,6);ctx.fillStyle="rgb(100,100,255)";var energy=this.player.energy;if(energy>this.player.ENERGY_INIT){energy=this.player.ENERGY_INIT}ctx.fillRect(5,5,energy/(this.player.ENERGY_INIT/100),5);for(var i=0;i<this.game.lives;i++){if(BITMAPS){ctx.drawImage(g_playerImg,0,0,64,64,380+i*20,0,16,16)}else{ctx.save();ctx.strokeStyle="white";ctx.translate(380+i*16,8);ctx.beginPath();ctx.moveTo(-4,6);ctx.lineTo(4,6);ctx.lineTo(0,-6);ctx.closePath();ctx.stroke();ctx.restore()}}var score=this.game.score;var inc=(score-this.scoredisplay)/10;this.scoredisplay+=inc;if(this.scoredisplay>score){this.scoredisplay=score}var sscore=Ceil(this.scoredisplay).toString();for(var i=0,j=8-sscore.length;i<j;i++){sscore="0"+sscore}Game.fillText(ctx,sscore,"12pt Courier New",120,12,"white");if(score>this.game.highscore){this.game.highscore=score}sscore=this.game.highscore.toString();for(var i=0,j=8-sscore.length;i<j;i++){sscore="0"+sscore}Game.fillText(ctx,Game.Util.message("hi-score")+": "+sscore,"12pt Courier New",220,12,"white");if(DEBUG&&DEBUG.FPS){Game.fillText(ctx,"FPS: "+GameHandler.maxfps,"12pt Courier New",0,GameHandler.height-2,"lightblue")}ctx.restore()}})})();(function(){Asteroids.Star=function(){return this};Asteroids.Star.prototype={MAXZ:12,VELOCITY:.85,x:0,y:0,z:0,prevx:0,prevy:0,init:function init(){this.prevx=this.prevy=0;this.x=(Rnd()*GameHandler.width-GameHandler.width*.5)*this.MAXZ;this.y=(Rnd()*GameHandler.height-GameHandler.height*.5)*this.MAXZ;this.z=this.MAXZ},render:function render(ctx){var xx=this.x/this.z;var yy=this.y/this.z;if(this.prevx){ctx.lineWidth=1/this.z*5+1;ctx.beginPath();ctx.moveTo(this.prevx+GameHandler.width*.5,this.prevy+GameHandler.height*.5);ctx.lineTo(xx+GameHandler.width*.5,yy+GameHandler.height*.5);ctx.stroke()}this.prevx=xx;this.prevy=yy}}})();(function(){Asteroids.Particles=function(p,v,count,fnEmitter){Asteroids.Particles.superclass.constructor.call(this,p,v);this.particles=new Array(count);for(var i=0;i<count;i++){this.particles[i]=fnEmitter.call(this,i)}return this};extend(Asteroids.Particles,Game.Actor,{particles:null,onRender:function onRender(ctx){ctx.save();ctx.shadowBlur=0;ctx.globalCompositeOperation="lighter";for(var i=0,particle;i<this.particles.length;i++){particle=this.particles[i];if(particle.update()){ctx.save();particle.render(ctx);ctx.restore()}else{this.particles.splice(i,1)}}ctx.restore()},expired:function expired(){return this.particles.length===0}})})();function AsteroidsParticle(position,vector,size,type,lifespan,fadelength,colour){this.particleStart=GameHandler.frameStart;this.position=position;this.vector=vector;this.size=size;this.type=type;this.lifespan=lifespan;this.fadelength=fadelength;this.colour=colour?colour:Asteroids.Colours.PARTICLE;if(type===1){this.rotate=Rnd()*TWOPI;this.rotationv=(Rnd()-.5)*.5}this.fadeValue=function(val,offset){var rem=this.lifespan-(GameHandler.frameStart-this.particleStart),result=val;if(rem<offset){result=val/offset*rem;if(result<0)result=0;else if(result>val)result=val}return result};this.update=function(){this.position.add(this.vector);return!(GameHandler.frameStart-this.particleStart>this.lifespan)};this.render=function(ctx){ctx.globalAlpha=this.fadeValue(1,this.fadelength);switch(this.type){case 0:ctx.translate(this.position.x,this.position.y);ctx.drawImage(GameHandler.bitmaps.images["points_"+this.colour][this.size],0,0);break;case 1:ctx.translate(this.position.x,this.position.y);var s=this.size;ctx.rotate(this.rotate);this.rotate+=this.rotationv;ctx.strokeStyle=this.colour;ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(-s,-s);ctx.lineTo(s,s);ctx.closePath();ctx.stroke();break;case 2:var offset=this.size+1<<2;Game.Util.renderImage(ctx,GameHandler.bitmaps.images["smudges_"+this.colour][this.size],0,0,this.size+1<<3,this.position.x-offset,this.position.y-offset,this.size+1<<3);break}}}(function(){Asteroids.AsteroidExplosion=function(p,v,asteroid){var count=BITMAPS?asteroid.size*2:asteroid.size+2;Asteroids.AsteroidExplosion.superclass.constructor.call(this,p,v,count,function(){var pos=p.clone();if(BITMAPS){if(Rnd()<.5){var t=new Vector(0,randomInt(5,10));t.rotate(Rnd()*TWOPI).add(v);return new AsteroidsParticle(pos,t,~~(Rnd()*4),0,400,300)}else{var t=new Vector(0,randomInt(1,3));t.rotate(Rnd()*TWOPI).add(v);return new AsteroidsParticle(pos,t,~~(Rnd()*4)+asteroid.size,2,500,250)}}else{var t=new Vector(0,randomInt(2,5));t.rotate(Rnd()*TWOPI).add(v);return new AsteroidsParticle(pos,t,Rnd()*asteroid.size+4,1,400,300,"white")}});return this};extend(Asteroids.AsteroidExplosion,Asteroids.Particles)})();(function(){Asteroids.PlayerExplosion=function(p,v){var count=BITMAPS?12:3;Asteroids.PlayerExplosion.superclass.constructor.call(this,p,v,count,function(){var pos=p.clone();if(BITMAPS){if(Rnd()<.5){var t=new Vector(0,randomInt(5,10));t.rotate(Rnd()*TWOPI).add(v);return new AsteroidsParticle(pos,t,~~(Rnd()*4),0,400,300)}else{var t=new Vector(0,randomInt(1,3));t.rotate(Rnd()*TWOPI).add(v);return new AsteroidsParticle(pos,t,~~(Rnd()*4)+2,2,500,250)}}else{var t=new Vector(0,randomInt(2,5));t.rotate(Rnd()*TWOPI).add(v);return new AsteroidsParticle(pos,t,6,1,400,300,"white")}});return this};extend(Asteroids.PlayerExplosion,Asteroids.Particles)})();(function(){Asteroids.EnemyExplosion=function(p,v,enemy){var count=BITMAPS?8:6;Asteroids.EnemyExplosion.superclass.constructor.call(this,p,v,count,function(){var pos=p.clone();if(BITMAPS){if(Rnd()<.5){var t=new Vector(0,randomInt(5,10));t.rotate(Rnd()*TWOPI).add(v);return new AsteroidsParticle(pos,t,~~(Rnd()*4),0,400,300,Asteroids.Colours.ENEMY_SHIP)}else{var t=new Vector(0,randomInt(1,3));t.rotate(Rnd()*TWOPI).add(v);return new AsteroidsParticle(pos,t,~~(Rnd()*4)+(enemy.size===0?2:0),2,500,250,Asteroids.Colours.ENEMY_SHIP)}}else{var t=new Vector(0,randomInt(2,4));t.rotate(Rnd()*TWOPI).add(v);return new AsteroidsParticle(pos,t,enemy.size===0?8:4,1,400,300,Asteroids.Colours.ENEMY_SHIP)}});return this};extend(Asteroids.EnemyExplosion,Asteroids.Particles)})();(function(){Asteroids.Explosion=function(p,v,s){Asteroids.Explosion.superclass.constructor.call(this,p,v,this.FADE_LENGTH);this.size=s;return this};extend(Asteroids.Explosion,Game.EffectActor,{FADE_LENGTH:300,size:0,onRender:function onRender(ctx){var brightness=Floor(this.effectValue(255)),rad=this.effectValue(this.size*8),rgb=brightness.toString();ctx.save();ctx.globalAlpha=.75;ctx.fillStyle="rgb("+rgb+",0,0)";ctx.beginPath();ctx.arc(this.position.x,this.position.y,rad,0,TWOPI,true);ctx.closePath();ctx.fill();ctx.restore()}})})();(function(){Asteroids.PlayerBulletImpact=function(p,v){Asteroids.PlayerBulletImpact.superclass.constructor.call(this,p,v,5,function(){var t=v.nscale(.75+Rnd()*.5);t.rotate(Rnd()*PIO4-PIO8);return new AsteroidsParticle(p.clone(),t,~~(Rnd()*4),0,250,150,Asteroids.Colours.GREEN_LASER)});return this};extend(Asteroids.PlayerBulletImpact,Asteroids.Particles)})();(function(){Asteroids.EnemyBulletImpact=function(p,v){Asteroids.EnemyBulletImpact.superclass.constructor.call(this,p,v,5,function(){var t=v.nscale(.75+Rnd()*.5);t.rotate(Rnd()*PIO4-PIO8);return new AsteroidsParticle(p.clone(),t,~~(Rnd()*4),0,250,150,Asteroids.Colours.ENEMY_SHIP)});return this};extend(Asteroids.EnemyBulletImpact,Asteroids.Particles)})();(function(){Asteroids.TextIndicator=function(p,v,msg,textSize,colour,fadeLength){this.fadeLength=fadeLength?fadeLength:this.DEFAULT_FADE_LENGTH;Asteroids.TextIndicator.superclass.constructor.call(this,p,v,this.fadeLength);this.msg=msg;if(textSize)this.textSize=textSize;if(colour)this.colour=colour;return this};extend(Asteroids.TextIndicator,Game.EffectActor,{DEFAULT_FADE_LENGTH:500,fadeLength:0,textSize:12,msg:null,colour:"white",onRender:function onRender(ctx){var alpha=this.effectValue(1);ctx.save();ctx.globalAlpha=alpha;Game.fillText(ctx,this.msg,this.textSize+"pt Courier New",this.position.x,this.position.y,this.colour);ctx.restore()}})})();(function(){Asteroids.ScoreIndicator=function(p,v,score,textSize,prefix,colour,fadeLength){var msg=score.toString();if(prefix){msg=prefix+" "+msg}Asteroids.ScoreIndicator.superclass.constructor.call(this,p,v,msg,textSize,colour,fadeLength);return this};extend(Asteroids.ScoreIndicator,Asteroids.TextIndicator)})();(function(){Asteroids.PowerUp=function(p,v){Asteroids.PowerUp.superclass.constructor.call(this,p,v);return this};extend(Asteroids.PowerUp,Game.EffectActor,{RADIUS:8,pulse:128,pulseinc:5,onRender:function onRender(ctx){ctx.save();ctx.globalAlpha=.75;var col="rgb(255,"+this.pulse.toString()+",0)";if(BITMAPS){ctx.fillStyle=col;ctx.strokeStyle="rgb(255,255,128)"}else{ctx.lineWidth=2;ctx.shadowColor=ctx.strokeStyle=col}ctx.beginPath();ctx.arc(this.position.x,this.position.y,this.RADIUS,0,TWOPI,true);ctx.closePath();if(BITMAPS){ctx.fill()}ctx.stroke();ctx.restore();this.pulse+=this.pulseinc;if(this.pulse>255){this.pulse=256-this.pulseinc;this.pulseinc=-this.pulseinc}else if(this.pulse<0){this.pulse=0-this.pulseinc;this.pulseinc=-this.pulseinc}},radius:function radius(){return this.RADIUS},collected:function collected(game,player,scene){var message=null;switch(randomInt(0,9)){case 0:case 1:message=Game.Util.message("powerup-energy-boost");player.energy+=player.ENERGY_INIT/2;if(player.energy>player.ENERGY_INIT){player.energy=player.ENERGY_INIT}break;case 2:message=Game.Util.message("powerup-fire-shielded");player.fireWhenShield=true;break;case 3:message=Game.Util.message("powerup-extra-life");game.lives++;break;case 4:message=Game.Util.message("powerup-slow-asteroids");for(var n=0,m=scene.enemies.length,enemy;n<m;n++){enemy=scene.enemies[n];if(enemy instanceof Asteroids.Asteroid){enemy.vector.scale(.66)}}break;case 5:message=Game.Util.message("powerup-smart-bomb");var effectRad=96;var boom=new Asteroids.Explosion(this.position.clone(),this.vector.clone().scale(.5),effectRad/8);scene.effects.push(boom);for(var n=0,enemy,pos=this.position;n<scene.enemies.length;n++){enemy=scene.enemies[n];if(pos.distance(enemy.position)<=effectRad+enemy.radius()){enemy.hit(-1);scene.generatePowerUp(enemy);scene.destroyEnemy(enemy,this.vector,true)}}break;case 6:message=Game.Util.message("powerup-twin-cannons");player.primaryWeapons["main"]=new Asteroids.TwinCannonsWeapon(player);break;case 7:message=Game.Util.message("powerup-spray-cannons");player.primaryWeapons["main"]=new Asteroids.VSprayCannonsWeapon(player);break;case 8:message=Game.Util.message("powerup-rear-gun");player.primaryWeapons["rear"]=new Asteroids.RearGunWeapon(player);break;case 9:message=Game.Util.message("powerup-side-guns");player.primaryWeapons["side"]=new Asteroids.SideGunWeapon(player);break}if(message){var vec=new Vector(0,-1.5);var effect=new Asteroids.TextIndicator(new Vector(this.position.x,this.position.y-this.RADIUS),vec,message,null,null,700);scene.effects.push(effect)}}})})();(function(){Asteroids.Asteroid=function(p,v,s,t){Asteroids.Asteroid.superclass.constructor.call(this,p,v);this.size=s;this.health=s;if(t===undefined){t=randomInt(1,4)}this.animImage=g_asteroidImgs[t-1];this.type=t;this.animForward=Rnd()<.5;this.animSpeed=.3+Rnd()*.5;this.animLength=this.ANIMATION_LENGTH;this.rotation=randomInt(0,180);this.rotationSpeed=(Rnd()-.5)/30;return this};extend(Asteroids.Asteroid,Game.EnemyActor,{ANIMATION_LENGTH:25,size:0,type:1,health:0,rotation:0,rotationSpeed:0,onRender:function onRender(ctx){var rad=this.size*8;ctx.save();if(BITMAPS){this.renderSprite(ctx,this.position.x-rad-2,this.position.y-rad-2,rad*2+4)}else{var imgsize=rad*2+GLOWSHADOWBLUR*2;Game.Util.renderImageRotated(ctx,GameHandler.bitmaps.images["asteroid"][this.type-1][this.size-1],this.position.x,this.position.y,imgsize,imgsize,this.rotation+=this.rotationSpeed)}ctx.restore()},radius:function radius(){return this.size*8},hit:function hit(force){if(force!==-1){this.health-=force}else{this.health=0}return!(this.alive=this.health>0)}})})();(function(){Asteroids.EnemyShip=function(scene,size){this.size=size;if(this.size===1){this.BULLET_RECHARGE_MS=1300;this.RADIUS=8}var p,v;if(scene.player.position.x<GameHandler.width/2){if(scene.player.position.y<GameHandler.height/2){p=new Vector(GameHandler.width-48,GameHandler.height-48)}else{p=new Vector(GameHandler.width-48,48)}v=new Vector(-(Rnd()+.25+size*.75),Rnd()+.25+size*.75)}else{if(scene.player.position.y<GameHandler.height/2){p=new Vector(0,GameHandler.height-48)}else{p=new Vector(0,48)}v=new Vector(Rnd()+.25+size*.75,Rnd()+.25+size*.75)}this.animImage=g_enemyshipImg;this.animLength=this.SHIP_ANIM_LENGTH;Asteroids.EnemyShip.superclass.constructor.call(this,p,v);return this};extend(Asteroids.EnemyShip,Game.EnemyActor,{SHIP_ANIM_LENGTH:90,RADIUS:16,BULLET_RECHARGE_MS:1800,alive:true,size:0,bulletRecharge:0,onUpdate:function onUpdate(scene){if(this.size===0){if(Rnd()<.01){this.vector.y=-(this.vector.y+(.25-Rnd()/2))}}else{if(Rnd()<.02){this.vector.y=-(this.vector.y+(.5-Rnd()))}}if(GameHandler.frameStart-this.bulletRecharge>this.BULLET_RECHARGE_MS&&scene.player.alive){this.bulletRecharge=GameHandler.frameStart;var v=scene.player.position.clone().sub(this.position);var scale=(this.size===0?3:3.5)/v.length();v.x*=scale;v.y*=scale;v.x+=this.size===0?Rnd()*2-1:Rnd()-.5;v.y+=this.size===0?Rnd()*2-1:Rnd()-.5;var bullet=new Asteroids.EnemyBullet(this.position.clone(),v);scene.enemyBullets.push(bullet);GameHandler.playSound("enemy_bomb")}},onRender:function onRender(ctx){if(BITMAPS){var rad=this.RADIUS+2;this.renderSprite(ctx,this.position.x-rad,this.position.y-rad,rad*2,true)}else{ctx.save();ctx.translate(this.position.x,this.position.y);if(this.size===0){ctx.scale(2,2);ctx.lineWidth=.75}ctx.beginPath();ctx.moveTo(0,-4);ctx.lineTo(8,3);ctx.lineTo(0,8);ctx.lineTo(-8,3);ctx.lineTo(0,-4);ctx.closePath();ctx.shadowColor=ctx.strokeStyle=Asteroids.Colours.ENEMY_SHIP_DARK;ctx.stroke();ctx.beginPath();ctx.moveTo(0,-8);ctx.lineTo(4,-4);ctx.lineTo(0,0);ctx.lineTo(-4,-4);ctx.lineTo(0,-8);ctx.closePath();ctx.shadowColor=ctx.strokeStyle=Asteroids.Colours.ENEMY_SHIP;ctx.stroke();ctx.restore()}},radius:function radius(){return this.RADIUS},hit:function hit(){this.alive=false;return true},expired:function expired(){return!this.alive}})})();(function(){Asteroids.Player=function(p,v,h){Asteroids.Player.superclass.constructor.call(this,p,v);this.heading=h;this.energy=this.ENERGY_INIT;this.animImage=g_shieldImg;this.animLength=this.SHIELD_ANIM_LENGTH;this.primaryWeapons=[];return this};extend(Asteroids.Player,Game.SpriteActor,{MAX_PLAYER_VELOCITY:8,PLAYER_RADIUS:9,SHIELD_RADIUS:14,SHIELD_ANIM_LENGTH:100,SHIELD_MIN_PULSE:20,ENERGY_INIT:400,THRUST_DELAY_MS:100,BOMB_RECHARGE_MS:800,BOMB_ENERGY:80,heading:0,energy:0,shieldCounter:0,alive:true,primaryWeapons:null,bombRecharge:0,thrustRecharge:0,engineThrust:false,killedOn:0,fireWhenShield:false,onRender:function onRender(ctx){var headingRad=this.heading*RAD;if(this.engineThrust){ctx.save();ctx.translate(this.position.x,this.position.y);ctx.rotate(headingRad);ctx.globalAlpha=.5+Rnd()*.5;if(BITMAPS){ctx.globalCompositeOperation="lighter";ctx.fillStyle=Asteroids.Colours.PLAYER_THRUST}else{ctx.shadowColor=ctx.strokeStyle=Asteroids.Colours.PLAYER_THRUST}ctx.beginPath();ctx.moveTo(-5,8);ctx.lineTo(5,8);ctx.lineTo(0,18+Rnd()*6);ctx.closePath();if(BITMAPS)ctx.fill();else ctx.stroke();ctx.restore();this.engineThrust=false}if(BITMAPS){var size=this.PLAYER_RADIUS*2+6;var normAngle=Floor(this.heading)%360;if(normAngle<0){normAngle=360+normAngle}ctx.save();ctx.drawImage(g_playerImg,0,Floor(normAngle/4)*64,64,64,this.position.x-size/2,this.position.y-size/2,size,size);ctx.restore()}else{ctx.save();ctx.shadowColor=ctx.strokeStyle="#fff";ctx.translate(this.position.x,this.position.y);ctx.rotate(headingRad);ctx.beginPath();ctx.moveTo(-6,8);ctx.lineTo(6,8);ctx.lineTo(0,-8);ctx.closePath();ctx.stroke();ctx.restore()}if(this.shieldCounter>0&&this.energy>0){if(BITMAPS){ctx.save();ctx.translate(this.position.x,this.position.y);ctx.rotate(headingRad);this.renderSprite(ctx,-this.SHIELD_RADIUS-1,-this.SHIELD_RADIUS-1,this.SHIELD_RADIUS*2+2);ctx.restore()}else{ctx.save();ctx.translate(this.position.x,this.position.y);ctx.rotate(headingRad);ctx.shadowColor=ctx.strokeStyle=Asteroids.Colours.PLAYER_SHIELD;ctx.beginPath();ctx.arc(0,2,this.SHIELD_RADIUS,0,TWOPI,true);ctx.closePath();ctx.stroke();ctx.restore()}this.shieldCounter--;this.energy-=1.5}},thrust:function thrust(){if(GameHandler.frameStart-this.thrustRecharge>this.THRUST_DELAY_MS){this.thrustRecharge=GameHandler.frameStart;var t=new Vector(0,!iOS?-.5:-1.25);t.rotate(this.heading*RAD);this.vector.add(t);if(this.vector.length()>this.MAX_PLAYER_VELOCITY){this.vector.scale(this.MAX_PLAYER_VELOCITY/this.vector.length())}}this.engineThrust=true},activateShield:function activateShield(){if(this.energy>=this.SHIELD_MIN_PULSE){this.shieldCounter=this.SHIELD_MIN_PULSE}},isShieldActive:function isShieldActive(){return this.shieldCounter>0&&this.energy>0},radius:function radius(){return this.isShieldActive()?this.SHIELD_RADIUS:this.PLAYER_RADIUS},expired:function expired(){return!this.alive},kill:function kill(){this.alive=false;this.killedOn=GameHandler.frameStart},firePrimary:function firePrimary(bulletList){var playedSound=false;if(this.alive&&(!this.isShieldActive()||this.fireWhenShield)){for(var w in this.primaryWeapons){var b=this.primaryWeapons[w].fire();if(b){if(isArray(b)){for(var i=0;i<b.length;i++){bulletList.push(b[i])}}else{bulletList.push(b)}if(!playedSound){GameHandler.playSound("laser");playedSound=true}}}}},fireSecondary:function fireSecondary(bulletList){if(this.alive&&(!this.isShieldActive()||this.fireWhenShield)&&this.energy>this.BOMB_ENERGY){if(GameHandler.frameStart-this.bombRecharge>this.BOMB_RECHARGE_MS){this.bombRecharge=GameHandler.frameStart;this.energy-=this.BOMB_ENERGY;var t=new Vector(0,-3);t.rotate(this.heading*RAD);t.add(this.vector);bulletList.push(new Asteroids.Bomb(this.position.clone(),t))}}},onUpdate:function onUpdate(){if(!this.isShieldActive()&&this.energy<this.ENERGY_INIT){this.energy+=.1}},reset:function reset(persistPowerUps){this.alive=true;if(!persistPowerUps){this.primaryWeapons=[];this.primaryWeapons["main"]=new Asteroids.PrimaryWeapon(this);this.fireWhenShield=false}this.energy=this.ENERGY_INIT+this.SHIELD_MIN_PULSE;this.activateShield()}})})();(function(){Asteroids.Prerenderer=function(){Asteroids.Prerenderer.superclass.constructor.call(this);var fnPointRenderer=function(buffer,colour){var imgs=[];for(var size=3;size<=6;size++){var width=size<<1;buffer.width=buffer.height=width;var ctx=buffer.getContext("2d");var radgrad=ctx.createRadialGradient(size,size,size>>1,size,size,size);radgrad.addColorStop(0,colour);radgrad.addColorStop(1,"#000");ctx.fillStyle=radgrad;ctx.fillRect(0,0,width,width);var img=new Image;img.src=buffer.toDataURL("image/png");imgs.push(img)}return imgs};this.addRenderer(function(buffer){return fnPointRenderer.call(this,buffer,Asteroids.Colours.PARTICLE)},"points_"+Asteroids.Colours.PARTICLE);this.addRenderer(function(buffer){return fnPointRenderer.call(this,buffer,Asteroids.Colours.GREEN_LASER)},"points_"+Asteroids.Colours.GREEN_LASER);this.addRenderer(function(buffer){return fnPointRenderer.call(this,buffer,Asteroids.Colours.ENEMY_SHIP)},"points_"+Asteroids.Colours.ENEMY_SHIP);var fnSmudgeRenderer=function(buffer,colour){var imgs=[];for(var size=4;size<=32;size+=4){var width=size<<1;buffer.width=buffer.height=width;var ctx=buffer.getContext("2d");var radgrad=ctx.createRadialGradient(size,size,size>>3,size,size,size);radgrad.addColorStop(0,colour);radgrad.addColorStop(1,"#000");ctx.fillStyle=radgrad;ctx.fillRect(0,0,width,width);var img=new Image;img.src=buffer.toDataURL("image/png");imgs.push(img)}return imgs};this.addRenderer(function(buffer){return fnSmudgeRenderer.call(this,buffer,Asteroids.Colours.PARTICLE)},"smudges_"+Asteroids.Colours.PARTICLE);this.addRenderer(function(buffer){return fnSmudgeRenderer.call(this,buffer,Asteroids.Colours.ENEMY_SHIP)},"smudges_"+Asteroids.Colours.ENEMY_SHIP);this.addRenderer(function(buffer){var BULLET_WIDTH=2,BULLET_HEIGHT=6;var imgs=[];buffer.width=BULLET_WIDTH+GLOWSHADOWBLUR*2;buffer.height=BULLET_HEIGHT+GLOWSHADOWBLUR*2;var ctx=buffer.getContext("2d");var rf=function(width,height){ctx.beginPath();ctx.moveTo(0,height);ctx.lineTo(width,0);ctx.lineTo(0,-height);ctx.lineTo(-width,0);ctx.closePath()};ctx.shadowBlur=GLOWSHADOWBLUR;ctx.translate(buffer.width*.5,buffer.height*.5);ctx.shadowColor=ctx.fillStyle=Asteroids.Colours.GREEN_LASER_DARK;rf.call(this,BULLET_WIDTH-1,BULLET_HEIGHT-1);ctx.fill();ctx.shadowColor=ctx.fillStyle=Asteroids.Colours.GREEN_LASER;rf.call(this,BULLET_WIDTH,BULLET_HEIGHT);ctx.fill();var img=new Image;img.src=buffer.toDataURL("image/png");imgs.push(img);buffer.width=buffer.width;ctx.shadowBlur=GLOWSHADOWBLUR;ctx.translate(buffer.width*.5,buffer.height*.5);ctx.shadowColor=ctx.strokeStyle=Asteroids.Colours.GREEN_LASER_DARK;rf.call(this,BULLET_WIDTH-1,BULLET_HEIGHT-1);ctx.stroke();ctx.shadowColor=ctx.strokeStyle=Asteroids.Colours.GREEN_LASER;rf.call(this,BULLET_WIDTH,BULLET_HEIGHT);ctx.stroke();img=new Image;img.src=buffer.toDataURL("image/png");imgs.push(img);return imgs},"bullet");this.addRenderer(function(buffer){var BULLET_WIDTH=2,BULLET_HEIGHT=6;var imgs=[];buffer.width=BULLET_WIDTH+GLOWSHADOWBLUR*4;buffer.height=BULLET_HEIGHT+GLOWSHADOWBLUR*2;var ctx=buffer.getContext("2d");var rf=function(width,height){ctx.beginPath();ctx.moveTo(0,height);ctx.lineTo(width,0);ctx.lineTo(0,-height);ctx.lineTo(-width,0);ctx.closePath()};ctx.shadowBlur=GLOWSHADOWBLUR;ctx.translate(buffer.width*.5,buffer.height*.5);ctx.save();ctx.translate(-4,0);ctx.shadowColor=ctx.fillStyle=Asteroids.Colours.GREEN_LASERX2_DARK;rf.call(this,BULLET_WIDTH-1,BULLET_HEIGHT-1);ctx.fill();ctx.shadowColor=ctx.fillStyle=Asteroids.Colours.GREEN_LASERX2;rf.call(this,BULLET_WIDTH,BULLET_HEIGHT);ctx.fill();ctx.translate(8,0);ctx.shadowColor=ctx.fillStyle=Asteroids.Colours.GREEN_LASERX2_DARK;rf.call(this,BULLET_WIDTH-1,BULLET_HEIGHT-1);ctx.fill();ctx.shadowColor=ctx.fillStyle=Asteroids.Colours.GREEN_LASERX2;rf.call(this,BULLET_WIDTH,BULLET_HEIGHT);ctx.fill();ctx.restore();var img=new Image;img.src=buffer.toDataURL("image/png");imgs.push(img);buffer.width=buffer.width;ctx.shadowBlur=GLOWSHADOWBLUR;ctx.translate(buffer.width*.5,buffer.height*.5);ctx.save();ctx.translate(-4,0);ctx.shadowColor=ctx.strokeStyle=Asteroids.Colours.GREEN_LASERX2_DARK;rf.call(this,BULLET_WIDTH-1,BULLET_HEIGHT-1);ctx.stroke();ctx.shadowColor=ctx.strokeStyle=Asteroids.Colours.GREEN_LASERX2;rf.call(this,BULLET_WIDTH,BULLET_HEIGHT);ctx.stroke();ctx.translate(8,0);ctx.shadowColor=ctx.strokeStyle=Asteroids.Colours.GREEN_LASERX2_DARK;rf.call(this,BULLET_WIDTH-1,BULLET_HEIGHT-1);ctx.stroke();ctx.shadowColor=ctx.strokeStyle=Asteroids.Colours.GREEN_LASERX2;rf.call(this,BULLET_WIDTH,BULLET_HEIGHT);ctx.stroke();ctx.restore();img=new Image;img.src=buffer.toDataURL("image/png");imgs.push(img);return imgs},"bulletx2");this.addRenderer(function(buffer){var BOMB_RADIUS=4;var imgs=[];buffer.width=buffer.height=BOMB_RADIUS*2+GLOWSHADOWBLUR*2;var ctx=buffer.getContext("2d");var rf=function(){ctx.beginPath();ctx.moveTo(BOMB_RADIUS*2,0);for(var i=0;i<15;i++){ctx.rotate(PIO8);if(i%2===0){ctx.lineTo(BOMB_RADIUS*2/.525731*.200811,0)}else{ctx.lineTo(BOMB_RADIUS*2,0)}}ctx.closePath()};ctx.shadowBlur=GLOWSHADOWBLUR;ctx.shadowColor=ctx.fillStyle=Asteroids.Colours.PLAYER_BOMB;ctx.translate(buffer.width*.5,buffer.height*.5);rf.call(this);ctx.fill();var img=new Image;img.src=buffer.toDataURL("image/png");imgs.push(img);buffer.width=buffer.width;ctx.shadowBlur=GLOWSHADOWBLUR;ctx.shadowColor=ctx.strokeStyle=Asteroids.Colours.PLAYER_BOMB;ctx.lineWidth=1.5;ctx.translate(buffer.width*.5,buffer.height*.5);ctx.scale(.9,.9);rf.call(this);ctx.stroke();img=new Image;img.src=buffer.toDataURL("image/png");imgs.push(img);return imgs},"bomb");this.addRenderer(function(buffer){var img,imgs=[];for(var type=1;type<=4;type++){var sizeImgs=[];for(var size=1;size<=4;size++){buffer.width=buffer.height=size*16+GLOWSHADOWBLUR*2;var ctx=buffer.getContext("2d");ctx.shadowBlur=GLOWSHADOWBLUR;ctx.shadowColor=ctx.strokeStyle="white";ctx.translate(buffer.width*.5,buffer.height*.5);ctx.scale(size*.8,size*.8);ctx.lineWidth=.8/size*2.5;ctx.beginPath();switch(type){case 1:ctx.moveTo(0,10);ctx.lineTo(8,6);ctx.lineTo(10,-4);ctx.lineTo(4,-2);ctx.lineTo(6,-6);ctx.lineTo(0,-10);ctx.lineTo(-10,-3);ctx.lineTo(-10,5);break;case 2:ctx.moveTo(0,10);ctx.lineTo(8,6);ctx.lineTo(10,-4);ctx.lineTo(4,-2);ctx.lineTo(6,-6);ctx.lineTo(0,-10);ctx.lineTo(-8,-8);ctx.lineTo(-6,-3);ctx.lineTo(-8,-4);ctx.lineTo(-10,5);break;case 3:ctx.moveTo(-4,10);ctx.lineTo(1,8);ctx.lineTo(7,10);ctx.lineTo(10,-4);ctx.lineTo(4,-2);ctx.lineTo(6,-6);ctx.lineTo(0,-10);ctx.lineTo(-10,-3);ctx.lineTo(-10,5);break;case 4:ctx.moveTo(-8,10);ctx.lineTo(7,8);ctx.lineTo(10,-2);ctx.lineTo(6,-10);ctx.lineTo(-2,-8);ctx.lineTo(-6,-10);ctx.lineTo(-10,-6);ctx.lineTo(-7,0);break}ctx.closePath();ctx.stroke();img=new Image;img.src=buffer.toDataURL("image/png");sizeImgs.push(img)}imgs.push(sizeImgs)}return imgs},"asteroid");this.addRenderer(function(buffer){var BULLET_RADIUS=4;var imgs=[];buffer.width=buffer.height=BULLET_RADIUS*2+GLOWSHADOWBLUR*2;var ctx=buffer.getContext("2d");var rf=function(){ctx.beginPath();ctx.moveTo(BULLET_RADIUS*2,0);for(var i=0;i<7;i++){ctx.rotate(PIO4);if(i%2===0){ctx.lineTo(BULLET_RADIUS*2/.525731*.200811,0)}else{ctx.lineTo(BULLET_RADIUS*2,0)}}ctx.closePath()};ctx.shadowBlur=GLOWSHADOWBLUR;ctx.shadowColor=ctx.fillStyle=Asteroids.Colours.ENEMY_SHIP;ctx.translate(buffer.width*.5,buffer.height*.5);ctx.beginPath();ctx.arc(0,0,BULLET_RADIUS-1,0,TWOPI,true);ctx.closePath();ctx.fill();rf.call(this);ctx.fill();var img=new Image;img.src=buffer.toDataURL("image/png");imgs.push(img);buffer.width=buffer.width;ctx.shadowBlur=GLOWSHADOWBLUR;ctx.shadowColor=ctx.strokeStyle=Asteroids.Colours.ENEMY_SHIP;ctx.lineWidth=1.5;ctx.translate(buffer.width*.5,buffer.height*.5);ctx.scale(.9,.9);ctx.beginPath();ctx.arc(0,0,BULLET_RADIUS-1,0,TWOPI,true);ctx.closePath();ctx.stroke();rf.call(this);ctx.stroke();img=new Image;img.src=buffer.toDataURL("image/png");imgs.push(img);return imgs},"enemybullet");return this};extend(Asteroids.Prerenderer,Game.Prerenderer)})();(function(){Asteroids.Weapon=function(player){this.player=player;return this};Asteroids.Weapon.prototype={WEAPON_RECHARGE:125,weaponRecharge:0,player:null,fire:function(){if(GameHandler.frameStart-this.weaponRecharge>this.WEAPON_RECHARGE){this.weaponRecharge=GameHandler.frameStart;return this.doFire()}},doFire:function(){}}})();(function(){Asteroids.PrimaryWeapon=function(player){Asteroids.PrimaryWeapon.superclass.constructor.call(this,player);return this};extend(Asteroids.PrimaryWeapon,Asteroids.Weapon,{doFire:function(){var t=new Vector(0,-4.5);t.rotate(this.player.heading*RAD);t.add(this.player.vector);return new Asteroids.Bullet(this.player.position.clone(),t,this.player.heading)}})})();(function(){Asteroids.TwinCannonsWeapon=function(player){this.WEAPON_RECHARGE=150;Asteroids.TwinCannonsWeapon.superclass.constructor.call(this,player);return this};extend(Asteroids.TwinCannonsWeapon,Asteroids.Weapon,{doFire:function(){var t=new Vector(0,-4.5);t.rotate(this.player.heading*RAD);t.add(this.player.vector);return new Asteroids.BulletX2(this.player.position.clone(),t,this.player.heading)}})})();(function(){Asteroids.VSprayCannonsWeapon=function(player){this.WEAPON_RECHARGE=250;Asteroids.VSprayCannonsWeapon.superclass.constructor.call(this,player);return this};extend(Asteroids.VSprayCannonsWeapon,Asteroids.Weapon,{doFire:function(){var t,h;var bullets=[];h=this.player.heading-15;t=new Vector(0,-3.75).rotate(h*RAD).add(this.player.vector);bullets.push(new Asteroids.Bullet(this.player.position.clone(),t,h));h=this.player.heading;t=new Vector(0,-3.75).rotate(h*RAD).add(this.player.vector);bullets.push(new Asteroids.Bullet(this.player.position.clone(),t,h));h=this.player.heading+15;t=new Vector(0,-3.75).rotate(h*RAD).add(this.player.vector);bullets.push(new Asteroids.Bullet(this.player.position.clone(),t,h));return bullets}})})();(function(){Asteroids.SideGunWeapon=function(player){this.WEAPON_RECHARGE=250;Asteroids.SideGunWeapon.superclass.constructor.call(this,player);return this};extend(Asteroids.SideGunWeapon,Asteroids.Weapon,{doFire:function(){var t,h;var bullets=[];h=this.player.heading-90;t=new Vector(0,-4.5).rotate(h*RAD).add(this.player.vector);bullets.push(new Asteroids.Bullet(this.player.position.clone(),t,h,750));h=this.player.heading+90;t=new Vector(0,-4.5).rotate(h*RAD).add(this.player.vector);bullets.push(new Asteroids.Bullet(this.player.position.clone(),t,h,750));return bullets}})})();(function(){Asteroids.RearGunWeapon=function(player){this.WEAPON_RECHARGE=250;Asteroids.RearGunWeapon.superclass.constructor.call(this,player);return this};extend(Asteroids.RearGunWeapon,Asteroids.Weapon,{doFire:function(){var t=new Vector(0,-4.5);var h=this.player.heading+180;t.rotate(h*RAD);t.add(this.player.vector);return new Asteroids.Bullet(this.player.position.clone(),t,h,750)}})})();(function(){Asteroids.Bullet=function(p,v,h,lifespan){Asteroids.Bullet.superclass.constructor.call(this,p,v);this.heading=h;if(lifespan){this.lifespan=lifespan}this.bulletStart=GameHandler.frameStart;return this};extend(Asteroids.Bullet,Game.Actor,{BULLET_WIDTH:2,BULLET_HEIGHT:6,FADE_LENGTH:200,heading:0,lifespan:1300,bulletStart:0,powerLevel:1,onRender:function onRender(ctx){if(GameHandler.frameStart-this.bulletStart>40){ctx.save();if(BITMAPS)ctx.globalCompositeOperation="lighter";ctx.globalAlpha=this.fadeValue(1,this.FADE_LENGTH);ctx.translate(this.position.x,this.position.y);ctx.rotate(this.heading*RAD);ctx.drawImage(GameHandler.bitmaps.images["bullet"][BITMAPS?0:1],-(this.BULLET_WIDTH+GLOWSHADOWBLUR*2)*.5,-(this.BULLET_HEIGHT+GLOWSHADOWBLUR*2)*.5);ctx.restore()}},expired:function expired(){return GameHandler.frameStart-this.bulletStart>this.lifespan},effectRadius:function effectRadius(){return 0},radius:function radius(){return(this.BULLET_HEIGHT+this.BULLET_WIDTH)*.5},power:function power(){return this.powerLevel},fadeValue:function fadeValue(val,offset){var rem=this.lifespan-(GameHandler.frameStart-this.bulletStart),result=val;if(rem<offset){result=val/offset*rem;if(result<0)result=0;else if(result>val)result=val}return result}})})();(function(){Asteroids.BulletX2=function(p,v,h){Asteroids.BulletX2.superclass.constructor.call(this,p,v,h);this.lifespan=1750;this.powerLevel=2;return this};extend(Asteroids.BulletX2,Asteroids.Bullet,{onRender:function onRender(ctx){if(GameHandler.frameStart-this.bulletStart>40){ctx.save();if(BITMAPS)ctx.globalCompositeOperation="lighter";ctx.globalAlpha=this.fadeValue(1,this.FADE_LENGTH);ctx.translate(this.position.x,this.position.y);ctx.rotate(this.heading*RAD);ctx.drawImage(GameHandler.bitmaps.images["bulletx2"][BITMAPS?0:1],-(this.BULLET_WIDTH+GLOWSHADOWBLUR*4)*.5,-(this.BULLET_HEIGHT+GLOWSHADOWBLUR*2)*.5);ctx.restore()}},radius:function radius(){return this.BULLET_HEIGHT}})})();(function(){Asteroids.Bomb=function(p,v){Asteroids.Bomb.superclass.constructor.call(this,p,v);this.lifespan=3e3;return this};extend(Asteroids.Bomb,Asteroids.Bullet,{BOMB_RADIUS:4,FADE_LENGTH:200,EFFECT_RADIUS:45,onRender:function onRender(ctx){ctx.save();if(BITMAPS)ctx.globalCompositeOperation="lighter";ctx.globalAlpha=this.fadeValue(1,this.FADE_LENGTH);ctx.translate(this.position.x,this.position.y);ctx.rotate(GameHandler.frameStart%(360*32)/32);var scale=this.fadeValue(1,this.FADE_LENGTH);if(scale<=0)scale=.01;ctx.scale(scale,scale);ctx.drawImage(GameHandler.bitmaps.images["bomb"][BITMAPS?0:1],-(this.BOMB_RADIUS*2+GLOWSHADOWBLUR*2)*.5,-(this.BOMB_RADIUS*2+GLOWSHADOWBLUR*2)*.5);ctx.restore()},effectRadius:function effectRadius(){return this.EFFECT_RADIUS},radius:function radius(){return this.fadeValue(this.BOMB_RADIUS,this.FADE_LENGTH)}})})();(function(){Asteroids.EnemyBullet=function(p,v){Asteroids.EnemyBullet.superclass.constructor.call(this,p,v,0);this.lifespan=2800;return this};extend(Asteroids.EnemyBullet,Asteroids.Bullet,{BULLET_RADIUS:4,FADE_LENGTH:200,onRender:function onRender(ctx){ctx.save();ctx.globalAlpha=this.fadeValue(1,this.FADE_LENGTH);if(BITMAPS)ctx.globalCompositeOperation="lighter";ctx.translate(this.position.x,this.position.y);ctx.rotate(GameHandler.frameStart%(360*64)/64);var scale=this.fadeValue(1,this.FADE_LENGTH);if(scale<=0)scale=.01;ctx.scale(scale,scale);ctx.drawImage(GameHandler.bitmaps.images["enemybullet"][BITMAPS?0:1],-(this.BULLET_RADIUS*2+GLOWSHADOWBLUR*2)*.5,-(this.BULLET_RADIUS*2+GLOWSHADOWBLUR*2)*.5);ctx.restore()},radius:function radius(){return this.fadeValue(this.BULLET_RADIUS,this.FADE_LENGTH)+1}})})();